(()=>{function ge(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t||alert("getUserMedia is not implemented in this browser"),new Promise(function(n,s){t.call(navigator,e,n,s)})})}var C=(e,...t)=>{e.classList.remove(...t),e.offsetWidth,e.classList.add(...t)};var ve=440,Ee=69,xe=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function be(e){let t=Re(e);return{value:t%12,index:t,name:xe[t%12],cents:je(e,t),octave:Math.floor(t/12)-1,frequency:e}}function Ne(e){let[t,n]=e.split("_"),i=(Number(n)+1)*12+xe.indexOf(t);return he(i)}function Re(e){let t=12*(Math.log(e/ve)/Math.log(2));return Math.round(t)+Ee}function he(e){return ve*2**((e-Ee)/12)}function je(e,t){return Math.floor(1200*Math.log(e/he(t))/Math.log(2))}function Ye(e){return{[Symbol.iterator](){return e}}}function*Me(e,t=(n,s)=>n===s){let n=e[Symbol.iterator](),{done:s,value:i}=n.next();if(s)return;let y=[i],v=i;for(let m of Ye(n))t(m,v)?y.push(m):(yield y,y=[m]),v=m;yield y}function*Te(e,t){for(let n of e)if(t(n))yield n;else break}var we=e=>[].concat(...e),Se=(e,t)=>(e==null||e.pop(),e==null||e.unshift(t),e);var Ae=(e,t,n)=>e.reduce((s,i)=>n(i,t)<n(s,t)?i:s);var $=(e,t,n)=>e&&(e[t]=n),H=e=>!!e;function F(e,t){return new Promise(n=>e.addEventListener(t,n,{once:!0}))}var S=e=>new Promise(t=>setTimeout(t,e));var Ie=(e,t)=>{let n=!1,s;return(...i)=>{s=i,n||(t(...i),n=!0,setTimeout(()=>{n=!1,t(...s)},e))}};function A(e){return[...e].reduce((t,[n,s])=>(t[n]=s,t),{})}var _e=(e,t=1)=>Math.round(e/t)*t,Ce=e=>Math.max(0,Math.min(1,e));console.log("Licensed under AGPL-3.0: https://github.com/onlinemictest/ukulele-tuner");var Le=8192,qe=185,Ke=3500,Ve=15,We=5,Ze=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Oe=we([1,2,3,4,5,6,7,8].map(e=>Ze.map(t=>`${t}_${e}`))),l={gCEA:["G_4","C_4","E_4","A_4"],GCEA:["G_3","C_4","E_4","A_4"],DGBE:["D_3","G_3","B_3","E_4"]},a="gCEA",z=!1,Je=A(Object.entries(l).map(([e,t])=>[e,A(t.map(n=>[n,Ne(n)]))])),R=500,L={X:"translateX",Y:"translateY"},ze=(e,t)=>t?Ae(e,t,(n,s)=>Math.abs(Oe.indexOf(n)-Oe.indexOf(s))):void 0,Qe=(e,t)=>e.indexOf(t);ge();var et=e=>e[0]!==void 0,Q=3,tt=e=>t=>t[0]!==e||t[0]===e&&t.length<=Q;if(!("WebAssembly"in window)||!("AudioContext"in window)||!("createAnalyser"in AudioContext.prototype)||!("createScriptProcessor"in AudioContext.prototype)){if(!("WebAssembly"in window))throw alert("Browser not supported: 'WebAssembly' is not defined");if(!("AudioContext"in window))throw alert("Browser not supported: 'AudioContext' is not defined");if(!("createAnalyser"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createAnalyser' is not defined");if(!("createScriptProcessor"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createScriptProcessor' is not defined")}var nt="animate"in Element.prototype?e=>e.animate([{transform:"translateY(10vw) scale(0.33)"},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>C(e,"blob-animation"),ot="animate"in Element.prototype?e=>e.animate([{transform:"translateY(-10vw) scale(3) "},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>C(e,"shrink-animation"),ee=e=>document.getElementById(e);Aubio().then(({Pitch:e})=>{let t=document.getElementById("ukulele-tuner"),n=document.getElementById("audio-start"),s=document.getElementById("audio-pause"),i=document.getElementById("tune-up-text"),y=document.getElementById("tune-down-text"),v=document.getElementById("circle-text-play"),m=document.getElementById("circle-text-pluck"),O=document.getElementById("circle-text-complete"),B=document.getElementById("circle-text-error"),u=document.getElementById("circle-note"),x=document.getElementById("match-circle-l"),Be=document.getElementById("match-circle-r"),g=document.getElementById("inner-circle"),te=document.getElementById("select-tuning"),N=document.getElementById("tuned-jingle");N.volume=.001;let ke=.5,k=A(Object.keys(l).map(r=>[r,ee(r)])),j=A(Object.entries(l).map(([r,p])=>[r,A(p.map(M=>[M,ee(`${r}-${M}`)]))])),G=[1,2,3,4].map(r=>ee(`S_${r}-fill`));if(Object.values(k).slice(1).forEach(r=>{r.style.display="none"}),!t||!n||!s||!i||!y||!v||!m||!O||!B||!u||!x||!Be||!g||!te||!N||!Object.values(k).every(H)||!Object.values(j).every(r=>Object.values(r).every(H))||!G.every(H))return alert("Expected HTML element missing");let U=Ie(500,(r,p)=>{r?(i.classList.remove("show"),y.classList.remove("show")):(i.classList[p?"add":"remove"]("show"),y.classList[p?"remove":"add"]("show"))}),E,D,b,P,Y,q;x.style.transform=`${L.Y}(125%)`;let ne=()=>{n.style.display="block",s.style.display="none",v.style.opacity="1",m.style.opacity="0",u.style.opacity="0",u.style.color="",x.style.transform=`${L.Y}(125%)`,i.classList.remove("show"),y.classList.remove("show"),U(!0),nt(n)};s.addEventListener("click",async()=>{clearInterval(q),ne(),await Promise.race([F(n,"animationend"),S(250)]),b.disconnect(E.destination),D.disconnect(b),E.close(),Y.getTracks().forEach(r=>r.stop())}),n.addEventListener("click",async()=>{await N.play(),await S(1600),N.volume=ke},{once:!0}),te.addEventListener("change",r=>{k[a].style.display="none",a=r.target.value,k[a].style.display="block",z=!0}),n.addEventListener("click",async()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),n.style.display="none",s.style.display="block",ot(s),await Promise.race([F(s,"animationend"),S(250)]),E=new AudioContext,D=E.createAnalyser(),b=E.createScriptProcessor(Le,1,1),P=new e("default",Le,1,E.sampleRate),P.setSilence(-55);try{Y=await navigator.mediaDevices.getUserMedia({audio:!0}),E.createMediaStreamSource(Y).connect(D),D.connect(b),b.connect(E.destination),v.style.opacity="0",B.style.opacity="0",m.style.opacity="1";let r=!1,p=!1,M=!1,K=!1,oe,c,se,re=new Array(Ve).fill(void 0),T=new Map(l[a].map(d=>[d,[]])),h=new Map(l[a].map(d=>[d,!1])),Ge=(await F(b,"audioprocess")).inputBuffer.getChannelData(0),V=P.do(Ge);b.addEventListener("audioprocess",d=>{let w=d.inputBuffer.getChannelData(0);V=P.do(w)}),q=setInterval(()=>{var ae,ie,le,ce,ue,de;if(K)return;z&&(M=!1,c=void 0,g.style.transition="transform 100ms",g.style.transform="scale(1)",h=new Map(l[a].map(o=>[o,!1])),T=new Map(l[a].map(o=>[o,[]])),Object.values(j).forEach(o=>Object.values(o).forEach(f=>{var I;return $((I=f.querySelector("path"))==null?void 0:I.style,"fill","#e25c1b")})),G.forEach(o=>o.style.display="none"),z=!1);let d=be(V),w=d.name?`${d.name}_${d.octave}`:void 0;Se(re,w);let W=[...Me(re)],Z=W.filter(et);c=ze(l[a],(ae=Z.find(o=>o.length>Q))==null?void 0:ae[0]);let Ue=Z.every(o=>o.length<=Q),De=[...Te(Z,tt(c))].length>=3;if(Ue&&r)c=void 0,r=!1,v.style.opacity="0",m.style.opacity="1",u.style.opacity="0",u.style.color="",x.style.transform=`${L.Y}(125%)`,U(!0);else if(c&&!Number.isNaN(d.cents)&&N.paused){r=!0,p=!0;let o=c,f=Je[a][o],I=V<f,me=w===o?d.cents:I?-50:50,$e=Math.abs(me)*2,He=Math.min(10,Math.round(100/$e)),pe=_e(me,He),fe=(ie=T.get(o))!=null?ie:[],Fe=(le=h.get(o))!=null?le:!1;w===o&&pe===0&&fe.push(0);let X=Ce(fe.length/We),ye=pe*(1-X);U(w===o&&ye===0,I),m.style.opacity="0",u.style.opacity="1";let J=o.split("_")[0];oe!==J&&(u.innerText=J),oe=J,g.style.transition=`transform ${R}ms ease`,g.style.transform=`scale(${1-X})`,u.style.transition=`color ${R}ms ease`,u.style.color=X===1?"#fbfbfb":"#fbfbfb88",x.style.transition=`transform ${R}ms ease`,x.style.transform=`${L.Y}(${-ye}%)`,X===1&&!Fe&&($((ue=(ce=j[a][o])==null?void 0:ce.querySelector("path"))==null?void 0:ue.style,"fill","rgb(67,111,142)"),$((de=G[Qe(l[a],o)])==null?void 0:de.style,"display","block"),h.set(o,!0),S(R).then(()=>{N.play(),C(u,"explode"),G.every(_=>_.style.display==="block")&&!M&&(M=!0,K=!0,t.classList.add("all-tuned-up"),u.style.opacity="0",O.style.opacity="1",C(O,"explode"),c=void 0,h=new Map(l[a].map(_=>[_,!1])),T=new Map(l[a].map(_=>[_,[]])),x.style.transform=`${L.Y}(125%)`,U(!0),S(Ke).then(()=>{K=!1,t.classList.remove("all-tuned-up"),O.style.opacity="0"}))}))}let Pe=W[0][0]===void 0&&W[0].length>=2,Xe=se!==c;se=c,p&&Xe?(g.style.transition="transform 100ms",g.style.transform="scale(1)",h=new Map(l[a].map(o=>{var f;return o===c?[o,(f=h.get(o))!=null?f:!1]:[o,!1]})),T=new Map(l[a].map(o=>{var f;return o===c?[o,(f=T.get(o))!=null?f:[]]:[o,[]]})),p=!1):p&&(Pe||De)&&(c=void 0,g.style.transition="transform 100ms",g.style.transform="scale(1)",h=new Map(l[a].map(o=>[o,!1])),T=new Map(l[a].map(o=>[o,[]])),p=!1)},qe)}catch(r){clearInterval(q),ne(),v.style.opacity="0",B.innerText=r.message,B.style.opacity="1"}})});})();
/**
 * Copyright (C) 2021 Online Mic Test
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 * @license
 */
