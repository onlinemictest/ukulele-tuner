(()=>{function ge(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t||alert("getUserMedia is not implemented in this browser"),new Promise(function(n,s){t.call(navigator,e,n,s)})})}var C=(e,...t)=>{e.classList.remove(...t),e.offsetWidth,e.classList.add(...t)};var Ee=440,ve=69,xe=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function be(e){let t=Re(e);return{value:t%12,index:t,name:xe[t%12],cents:Ye(e,t),octave:Math.floor(t/12)-1,frequency:e}}function Ne(e){let[t,n]=e.split("_"),i=(Number(n)+1)*12+xe.indexOf(t);return he(i)}function Re(e){let t=12*(Math.log(e/Ee)/Math.log(2));return Math.round(t)+ve}function he(e){return Ee*2**((e-ve)/12)}function Ye(e,t){return Math.floor(1200*Math.log(e/he(t))/Math.log(2))}function je(e){return{[Symbol.iterator](){return e}}}function*Me(e,t=(n,s)=>n===s){let n=e[Symbol.iterator](),{done:s,value:i}=n.next();if(s)return;let f=[i],g=i;for(let p of je(n))t(p,g)?f.push(p):(yield f,f=[p]),g=p;yield f}function*Te(e,t){for(let n of e)if(t(n))yield n;else break}var we=e=>[].concat(...e),Se=(e,t)=>(e==null||e.pop(),e==null||e.unshift(t),e);var Ae=(e,t,n)=>e.reduce((s,i)=>n(i,t)<n(s,t)?i:s);var $=(e,t,n)=>e&&(e[t]=n),H=e=>!!e;function F(e,t){return new Promise(n=>e.addEventListener(t,n,{once:!0}))}var A=e=>new Promise(t=>setTimeout(t,e));var Ie=(e,t)=>{let n=!1,s;return(...i)=>{s=i,n||(t(...i),n=!0,setTimeout(()=>{n=!1,t(...s)},e))}};function I(e){return[...e].reduce((t,[n,s])=>(t[n]=s,t),{})}var _e=(e,t=1)=>Math.round(e/t)*t,Ce=e=>Math.max(0,Math.min(1,e));console.log("Licensed under AGPL-3.0: https://github.com/onlinemictest/ukulele-tuner");var Le=8192,qe=185,Ke=3500,Ve=15,We=5,Ze=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Be=we([1,2,3,4,5,6,7,8].map(e=>Ze.map(t=>`${t}_${e}`))),l={gCEA:["G_4","C_4","E_4","A_4"],GCEA:["G_3","C_4","E_4","A_4"],DGBE:["D_3","G_3","B_3","E_4"]},a="gCEA",J=!1,Je=I(Object.entries(l).map(([e,t])=>[e,I(t.map(n=>[n,Ne(n)]))])),R=500,L={X:"translateX",Y:"translateY"},ze=(e,t)=>t?Ae(e,t,(n,s)=>Math.abs(Be.indexOf(n)-Be.indexOf(s))):void 0,Qe=(e,t)=>e.indexOf(t);ge();var et=e=>e[0]!==void 0,z=3,tt=e=>t=>t[0]!==e||t[0]===e&&t.length<=z;if(!("WebAssembly"in window)||!("AudioContext"in window)||!("createAnalyser"in AudioContext.prototype)||!("createScriptProcessor"in AudioContext.prototype)){if(!("WebAssembly"in window))throw alert("Browser not supported: 'WebAssembly' is not defined");if(!("AudioContext"in window))throw alert("Browser not supported: 'AudioContext' is not defined");if(!("createAnalyser"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createAnalyser' is not defined");if(!("createScriptProcessor"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createScriptProcessor' is not defined")}var nt="animate"in Element.prototype?e=>e.animate([{transform:"translateY(10vw) scale(0.33)"},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>C(e,"blob-animation"),ot="animate"in Element.prototype?e=>e.animate([{transform:"translateY(-10vw) scale(3) "},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>C(e,"shrink-animation"),Q=e=>document.getElementById(e);Aubio().then(({Pitch:e})=>{let t=document.getElementById("ukulele-tuner"),n=document.getElementById("audio-start"),s=document.getElementById("audio-pause"),i=document.getElementById("tune-up-text"),f=document.getElementById("tune-down-text"),g=document.getElementById("circle-text-play"),p=document.getElementById("circle-text-pluck"),B=document.getElementById("circle-text-complete"),O=document.getElementById("circle-text-error"),d=document.getElementById("circle-note"),b=document.getElementById("match-circle-l"),Oe=document.getElementById("match-circle-r"),y=document.getElementById("inner-circle"),ee=document.getElementById("select-tuning"),T=document.getElementById("tuned-jingle");T.volume=.001;let ke=.5,k=I(Object.keys(l).map(r=>[r,Q(r)])),Y=I(Object.entries(l).map(([r,c])=>[r,I(c.map((N,v)=>[N,Q(`${r}-S${v+1}`)]))])),G=[1,2,3,4].map(r=>Q(`S${r}-fill`));if(!t||!n||!s||!i||!f||!g||!p||!B||!O||!d||!b||!Oe||!y||!ee||!T||!Object.values(k).every(H)||!Object.values(Y).every(r=>Object.values(r).every(H))||!G.every(H))return alert("Expected HTML element missing");let U=Ie(500,(r,c)=>{r?(i.classList.remove("show"),f.classList.remove("show")):(i.classList[c?"add":"remove"]("show"),f.classList[c?"remove":"add"]("show"))}),E,D,h,P,j,q;k[a].style.display="block",b.style.transform=`${L.Y}(125%)`;let te=()=>{n.style.display="block",s.style.display="none",g.style.opacity="1",p.style.opacity="0",d.style.opacity="0",d.style.color="",b.style.transform=`${L.Y}(125%)`,i.classList.remove("show"),f.classList.remove("show"),U(!0),nt(n)};s.addEventListener("click",async()=>{clearInterval(q),te(),await Promise.race([F(n,"animationend"),A(250)]),h.disconnect(E.destination),D.disconnect(h),E.close(),j.getTracks().forEach(r=>r.stop())}),n.addEventListener("click",async()=>{await T.play(),await A(1600),T.volume=ke},{once:!0}),ee.addEventListener("change",r=>{k[a].style.display="none",a=r.target.value,k[a].style.display="block",Object.values(Y).forEach(c=>Object.values(c).forEach(N=>{var v;return $((v=N.querySelector("path"))==null?void 0:v.style,"fill","#e25c1b")})),G.forEach(c=>c.style.display="none"),J=!0}),n.addEventListener("click",async()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),n.style.display="none",s.style.display="block",ot(s),await Promise.race([F(s,"animationend"),A(250)]),E=new AudioContext,D=E.createAnalyser(),h=E.createScriptProcessor(Le,1,1),P=new e("default",Le,1,E.sampleRate),P.setSilence(-55);try{j=await navigator.mediaDevices.getUserMedia({audio:!0}),E.createMediaStreamSource(j).connect(D),D.connect(h),h.connect(E.destination),g.style.opacity="0",O.style.opacity="0",p.style.opacity="1";let r=!1,c=!1,N=!1,v=!1,ne,u,oe,se=new Array(Ve).fill(void 0),w=new Map(l[a].map(m=>[m,[]])),M=new Map(l[a].map(m=>[m,!1])),Ge=(await F(h,"audioprocess")).inputBuffer.getChannelData(0),K=P.do(Ge);h.addEventListener("audioprocess",m=>{let S=m.inputBuffer.getChannelData(0);K=P.do(S)}),q=setInterval(()=>{var re,ae,ie,le,ce,ue;if(v)return;J&&(N=!1,u=void 0,y.style.transition="transform 100ms",y.style.transform="scale(1)",M=new Map(l[a].map(o=>[o,!1])),w=new Map(l[a].map(o=>[o,[]])),J=!1);let m=be(K),S=m.name?`${m.name}_${m.octave}`:void 0;Se(se,S);let V=[...Me(se)],W=V.filter(et);u=ze(l[a],(re=W.find(o=>o.length>z))==null?void 0:re[0]);let Ue=W.every(o=>o.length<=z),De=[...Te(W,tt(u))].length>=3;if(Ue&&r)u=void 0,r=!1,g.style.opacity="0",p.style.opacity="1",d.style.opacity="0",d.style.color="",b.style.transform=`${L.Y}(125%)`,U(!0);else if(u&&!Number.isNaN(m.cents)&&T.paused){r=!0,c=!0;let o=u,x=Je[a][o],de=K<x,me=S===o?m.cents:de?-50:50,$e=Math.abs(me)*2,He=Math.min(10,Math.round(100/$e)),pe=_e(me,He),fe=(ae=w.get(o))!=null?ae:[],Fe=(ie=M.get(o))!=null?ie:!1;S===o&&pe===0&&fe.push(0);let X=Ce(fe.length/We),ye=pe*(1-X);U(S===o&&ye===0,de),p.style.opacity="0",d.style.opacity="1";let Z=o.split("_")[0];ne!==Z&&(d.innerText=Z),ne=Z,y.style.transition=`transform ${R}ms ease`,y.style.transform=`scale(${1-X})`,d.style.transition=`color ${R}ms ease`,d.style.color=X===1?"#fbfbfb":"#fbfbfb88",b.style.transition=`transform ${R}ms ease`,b.style.transform=`${L.Y}(${-ye}%)`,X===1&&!Fe&&($((ce=(le=Y[a][o])==null?void 0:le.querySelector("path"))==null?void 0:ce.style,"fill","rgb(67,111,142)"),$((ue=G[Qe(l[a],o)])==null?void 0:ue.style,"display","block"),M.set(o,!0),A(R).then(()=>{T.play(),C(d,"explode"),G.every(_=>_.style.display==="block")&&!N&&(N=!0,v=!0,t.classList.add("all-tuned-up"),d.style.opacity="0",B.style.opacity="1",C(B,"explode"),u=void 0,M=new Map(l[a].map(_=>[_,!1])),w=new Map(l[a].map(_=>[_,[]])),b.style.transform=`${L.Y}(125%)`,U(!0),A(Ke).then(()=>{v=!1,t.classList.remove("all-tuned-up"),B.style.opacity="0"}))}))}let Pe=V[0][0]===void 0&&V[0].length>=2,Xe=oe!==u;oe=u,c&&Xe?(y.style.transition="transform 100ms",y.style.transform="scale(1)",M=new Map(l[a].map(o=>{var x;return o===u?[o,(x=M.get(o))!=null?x:!1]:[o,!1]})),w=new Map(l[a].map(o=>{var x;return o===u?[o,(x=w.get(o))!=null?x:[]]:[o,[]]})),c=!1):c&&(Pe||De)&&(u=void 0,y.style.transition="transform 100ms",y.style.transform="scale(1)",M=new Map(l[a].map(o=>[o,!1])),w=new Map(l[a].map(o=>[o,[]])),c=!1)},qe)}catch(r){clearInterval(q),te(),g.style.opacity="0",O.innerText=r.message,O.style.opacity="1"}})});})();
/**
 * Copyright (C) 2021 Online Mic Test
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 * @license
 */
